<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Split Flap</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="plugins/arrivals/custom.css">
</head>
<body>
    <div class="top-bar" style="position:relative; overflow:hidden;">
        <div class="info">
            <!-- CURRENT TIME -->
            <div id="current-time"></div>
            <!-- WEATHER DISPLAY -->
            <div id="weather-display"></div>
        </div>

        <!-- HOLIDAY GIF BANNER -->
        <div id="holiday-center">
            <div id="holiday-message"></div>
            <img id="holiday-gif" src="" alt="Holiday">
        </div>

        <!-- SOUND AND FULLSCREEN TOGGLES -->
        <div class="controls">
            <label><input type="checkbox" id="sound-toggle" checked> Sound</label>
            <label><input type="checkbox" id="fullscreen-toggle-checkbox"> Fullscreen</label>
        </div>
    </div>

    <!-- CONTAINER -->
    <div id="board" class="chartContainer splitflap">

        <!-- STATION SEARCH BAR -->
        <div style="text-align:center; position:relative;">
            <input id="station-search" type="text" placeholder="Search stations (name or id)" style="margin-bottom:8px; padding:6px; width:60%; max-width:600px; background:#111; color:#fff; border:1px solid #444; font-size: 2.2rem;" autocomplete="off" />
            <div id="station-results" style="position:absolute; left:50%; transform:translateX(-50%); top:42px; background:#0b0b0b; border:1px solid #333; max-height:220px; overflow:auto; width:60%; max-width:600px; z-index:1000; display:none;">
            </div>
            <!-- <h1 id="station-title" style="text-decoration: overline; margin:0">Loading...</h1> -->
        </div>

        <!-- Header: 30px/char, 15px/separator, 120px/logo -->
        <div class="header" style="width:120px;margin-left:0px;">Route</div>
        <div class="header" style="width:360px;margin-left:30px;text-align:left;">Destination</div>
        <div class="header" style="width:320px;margin-left:301px;">ETA (min)</div>
        <div class="header" style="width:270px;margin-left:80px;text-align:left;">Status</div>

        <!-- rows will be placed here dynamically from #row_template -->
    </div>
    <!-- END CONTAINER -->

    <!-- ROW TEMPLATE -->
    <script type="text/template" id="row_template">
        <div class="row">
            <div class="group line"> <!-- train line -->
                <div class="image"><span></span></div>
            </div>

            <div class="group terminal"> <!-- city -->
                <!-- Repeat full divs as needed -->
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
            </div>

            <div class="group scheduled"> <!-- scheduled -->
              <div class="number"><span></span></div>
              <div class="number"><span></span></div>
              <div class="number"><span></span></div>
            </div>

            <div class="group remarks"> <!-- remarks -->
                <!-- Repeat full divs as needed -->
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
                <div class="full"><span></span></div>
            </div>

            <div class="group status"> <!-- lights -->
                <div class="sA"></div>
                <div class="sB"></div>
            </div>
        </div>
    </script>
    <!-- END ROW TEMPLATE -->

    <!-- JS LIBRARIES -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>
    <script type="text/javascript" src="js/split-flap.js"></script>
    <script type="text/javascript" src="js/weather.js"></script>
    <script type="text/javascript" src="plugins/arrivals/custom.js"></script>

    <!-- CUSTOMIZATION OPTIONS AND SCRIPT INITIALIZATION -->
    <script type="text/javascript">
        sf.options = {
            plugin: 'arrivals', // Plugin to load
            container: $('#board'), // Where in the DOM to put the board
            template: $('#row_template'), // Where in the DOM to find the row template
            numRows: 45, // number of rows to generate
            sort: 'scheduled', // the column to sort by. Use 'scheduled' to sort by arrival time, 'line' to sort by train line, or 'terminal' to sort by destination.
            order: 'asc', // the order to sort by
            maxResults: 45, // number of results to retrieve from data feed
            pageInterval: 20000, // delay between pages (ms)
            stagger: 300 // delay between loading rows (ms)
        };

        // === HOLIDAY GIF BANNER LOGIC ===
        function loadHolidayBanner() {
            fetch('/holiday-info')
                .then(r => r.ok ? r.json() : Promise.reject())
                .then(data => {
                    const container = document.getElementById('holiday-center');
                    const msgEl = document.getElementById('holiday-message');
                    const gifEl = document.getElementById('holiday-gif');
                    const topBar = document.querySelector('.top-bar');

                    const updateHeight = () => {
                        if (!container.classList.contains('active')) return;
                        // Measure the actual content height
                        const rect = container.getBoundingClientRect();
                        const needed = rect.height + 40; // padding
                        topBar.style.minHeight = Math.max(80, needed) + 'px';
                    };

                    if (data.isHoliday && data.gifs && data.gifs.length > 0) {
                        msgEl.textContent = data.message;

                        let i = 0;
                        const rotate = () => {
                            const src = data.gifs[i] + '?t=' + Date.now();
                            if (gifEl.src !== src) {
                                gifEl.src = src;
                            }
                            i = (i + 1) % data.gifs.length;
                        };

                        gifEl.onload = updateHeight;
                        rotate();
                        setInterval(rotate, 3 * 60 * 1000);

                        container.classList.add('active');
                        if (data.isHoliday) {
                            setTimeout(updateWeatherScrollMargin, 200);
                        }
                        // Initial height after DOM update
                        setTimeout(updateHeight, 100);
                    } else {
                        container.classList.remove('active');
                        topBar.style.minHeight = '80px';
                    }
                })
                .catch(err => {
                    console.error('Holiday banner error:', err);
                    document.getElementById('holiday-center').classList.remove('active');
                    document.querySelector('.top-bar').style.minHeight = '80px';
                });
        }

        function updateWeatherScrollMargin() {
            const holiday = document.getElementById('holiday-center');
            const info = document.querySelector('.info');
            const weather = document.getElementById('weather-display');

            if (holiday && holiday.classList.contains('active')) {
                // When holiday banner is visible → reduce scroll area
                info.style.paddingRight = '100px';
                info.style.marginRight = '-70px';
                weather.style.width = 'calc(100% - 80px)';
            } else {
                // Normal day → full width
                info.style.paddingRight = '15px';
                info.style.marginRight = '0';
                weather.style.width = '100%';
            }
        }

        // Call it when holiday loads and on resize
        window.addEventListener('load', updateWeatherScrollMargin);
        window.addEventListener('resize', updateWeatherScrollMargin);

        // Also run on window resize
        window.addEventListener('resize', () => {
            if (document.querySelector('#holiday-center.active')) {
                const container = document.getElementById('holiday-center');
                const topBar = document.querySelector('.top-bar');
                const needed = container.getBoundingClientRect().height + 40;
                topBar.style.minHeight = Math.max(80, needed) + 'px';
            }
        });

        $(document).ready(function() {
            loadHolidayBanner();
            sf.board.init(sf.options);
            sf.items.init(sf.options);
            sf.items.load(sf.options);
            // Fit board to screen after initial load
            try { setTimeout(fitBoard, 250); } catch (e) {}

            // Update the current time every second
            function updateTime() {
                const now = new Date();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');

                // Determine AM or PM
                const ampm = hours >= 12 ? 'PM' : 'AM';

                // Convert hours to 12-hour format
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'

                const timeString = `${hours}:${minutes} ${ampm}`;
                $('#current-time').text(timeString);
            }

            setInterval(updateTime, 1000);
            updateTime(); // Initial call to display time immediately

            // Function to fetch and display weather for Brooklyn, NYC
            // Brooklyn coordinates: 40.6501°N, 73.9496°W
            function updateWeather() {
                if (typeof weather !== 'undefined') {
                    const params = new URLSearchParams({
                        latitude: 40.6501,
                        longitude: -73.9496,
                        current: 'temperature_2m,relative_humidity_2m,precipitation,rain,showers,snowfall,weather_code,cloud_cover',
                        daily: 'temperature_2m_max,temperature_2m_min',
                        temperature_unit: 'fahrenheit',
                        precipitation_unit: 'inch',
                        timezone: 'America/New_York'
                    });

                    fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`)
                        .then(response => response.json())
                        .then(rawData => {
                            if (rawData.error) throw new Error(rawData.reason);

                            const current = rawData.current || {};
                            const daily = rawData.daily || {};
                            const temp = Math.round(current.temperature_2m);
                            const weatherCode = current.weather_code;
                            const condition = weather.interpretWeatherCode(weatherCode);
                            const highTemp = daily.temperature_2m_max?.[0] ? Math.round(daily.temperature_2m_max[0]) : null;
                            const lowTemp = daily.temperature_2m_min?.[0] ? Math.round(daily.temperature_2m_min[0]) : null;

                            let weatherHTML = `${temp}°F | ${condition}`;
                            if (highTemp !== null && lowTemp !== null) {
                                weatherHTML += ` | H: ${highTemp}°F L: ${lowTemp}°F`;
                            }

                            // Insert with ticker wrapper and auto-detect overflow
                            $('#weather-display').html(`<div class="ticker">${weatherHTML}</div>`).removeClass('long');

                            setTimeout(() => {
                                const infoBox = document.querySelector('.info');
                                const ticker = document.querySelector('#weather-display .ticker');
                                
                                if (ticker && infoBox) {
                                    // Only scroll if weather text is wider than the .info container
                                    if (ticker.scrollWidth > infoBox.clientWidth + 10) {
                                        $('#weather-display').addClass('long');
                                    }
                                }
                            }, 100);
                        })
                        .catch(err => {
                            console.error('Weather API error:', err);
                            $('#weather-display').text('Weather unavailable');
                        });
                }
            }

            // Fetch weather immediately and then every 15 minutes (900000 ms)
            updateWeather();
            setInterval(updateWeather, 900000);

            // Load stations.csv and populate the dropdown, then set/get current station
            function parseCSV(text) {
                const lines = text.split(/\r?\n/).filter(Boolean);
                if (lines.length === 0) return [];
                const header = lines.shift();
                const rows = [];
                lines.forEach(line => {
                    // Try to extract stop_id and name robustly, handling quoted names
                    let stop_id = '';
                    let name = '';
                    // If name is quoted and may contain commas
                    const quotedMatch = line.match(/^([^,]+),"([^"]+)"(,|$)/);
                    if (quotedMatch) {
                        stop_id = quotedMatch[1];
                        name = quotedMatch[2];
                    } else {
                        // fallback: split by comma and take second column as name
                        const parts = line.split(',');
                        stop_id = parts[0] || '';
                        name = parts[1] || '';
                    }
                    rows.push({ stop_id: stop_id.trim(), name: name.trim() });
                });
                return rows;
            }

            $.get('/stations.csv', function(csvText) {
                const stations = parseCSV(csvText);
                const stationsArr = stations.filter(s => s && s.stop_id).map(s => ({ id: s.stop_id, name: s.name }));
                const $input = $('#station-search');
                const $results = $('#station-results');

                function renderResults(list) {
                    if (!list || list.length === 0) {
                        $results.hide();
                        return;
                    }
                    $results.empty();
                    list.forEach(item => {
                        const $row = $('<div>').addClass('station-result').attr('data-id', item.id).text(item.name + ' (' + item.id + ')').css({ padding: '6px 8px', cursor: 'pointer', borderBottom: '1px solid #222' });
                        $results.append($row);
                    });
                    $results.show();
                }

                function setStationById(id) {
                    const match = stationsArr.find(s => s.id === id);
                    const display = match ? (match.name + ' (' + match.id + ')') : id;
                    // call server to set station and wait for server to refresh data
                    $.get('/api/station', { station: id }, function() {
                        $input.val(display);
                        $('#station-title').text(display);
                        $results.hide();
                        // play 3s pulse for user-initiated station change
                        try { if (window.sf && sf.audio && sf.audio.pulse) { sf.audio.pulse(3000); } } catch (e) {}
                        // reload arrivals immediately
                        try { if (window.sf && sf.items && sf.options) { sf.items.load(sf.options); } } catch (e) { console.warn('Could not reload arrivals', e); }
                        // refit to screen after the change
                        try { setTimeout(fitBoard, 400); } catch (e) {}
                    }).fail(function() {
                        // still update UI locally
                        $input.val(display);
                        $('#station-title').text(display);
                        $results.hide();
                        // play 3s pulse for user-initiated station change
                        try { if (window.sf && sf.audio && sf.audio.pulse) { sf.audio.pulse(3000); } } catch (e) {}
                        try { if (window.sf && sf.items && sf.options) { sf.items.load(sf.options); } } catch (e) { console.warn('Could not reload arrivals', e); }
                        // refit to screen after the change
                        try { setTimeout(fitBoard, 400); } catch (e) {}
                    });
                }

                // Initialize input with server station if present
                $.get('/api/station', function(resp) {
                    const current = resp && resp.station ? resp.station : null;
                    if (current) {
                        const m = stationsArr.find(s => s.id === current);
                        const txt = m ? (m.name + ' (' + m.id + ')') : current;
                        $input.val(txt);
                        $('#station-title').text(txt);
                    } else if (stationsArr.length > 0) {
                        // set server to first station if none set
                        setStationById(stationsArr[0].id);
                    }
                }).fail(function(){
                    if (stationsArr.length > 0) {
                        const txt = stationsArr[0].name + ' (' + stationsArr[0].id + ')';
                        $input.val(txt);
                        $('#station-title').text(txt);
                    }
                });

                // input handler
                $input.on('input', function() {
                    const q = $(this).val().trim().toLowerCase();
                    if (!q) {
                        renderResults(stationsArr.slice(0, 50));
                        return;
                    }
                    const matches = stationsArr.filter(s => (s.name && s.name.toLowerCase().indexOf(q) !== -1) || (s.id && s.id.toLowerCase().indexOf(q) !== -1));
                    renderResults(matches.slice(0, 100));
                });

                // click handler for results
                $results.on('click', '.station-result', function(e) {
                    const id = $(this).attr('data-id');
                    setStationById(id);
                });

                // show suggestions on focus
                $input.on('focus', function() {
                    if ($input.val().trim() === '') {
                        renderResults(stationsArr.slice(0, 50));
                    } else {
                        $input.trigger('input');
                    }
                });

                // hide suggestions when clicking outside
                $(document).on('click', function(e) {
                    if (!$(e.target).closest('#station-search, #station-results').length) {
                        $results.hide();
                    }
                });

                // keyboard support: Enter to pick first result
                $input.on('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const first = $results.find('.station-result').first();
                        if (first.length) {
                            const id = first.attr('data-id');
                            setStationById(id);
                        }
                    }
                });

                // initialize audio helper
                try { sf.audio.init(); } catch (e) {}

                // sound toggle
                $('#sound-toggle').on('change', function() {
                    sf.audio.enabled = $(this).is(':checked');
                });

                // (Custom on-screen keyboard removed — relying on native keyboard and fullscreen toggle)

                // --- Auto-fit board to the viewport ---
                function fitBoard() {
                    try {
                        const el = document.getElementById('board');
                        if (!el) return;
                        // make sure transforms don't accumulate
                        el.style.transform = '';
                        el.style.transformOrigin = 'top left';
                        // measure content size
                        const contentW = el.scrollWidth || el.offsetWidth || el.getBoundingClientRect().width;
                        const contentH = el.scrollHeight || el.offsetHeight || el.getBoundingClientRect().height;
                        const vw = window.innerWidth || document.documentElement.clientWidth;
                        const vh = window.innerHeight || document.documentElement.clientHeight;
                        if (!contentW || !contentH) return;
                        // leave a small margin (2%) so nothing touches edges
                        const margin = 0.02;
                        const availW = vw * (1 - margin * 2);
                        const availH = vh * (1 - margin * 2);
                        const scaleW = availW / contentW;
                        // Fit horizontally only: choose width-based scale, clamp between 0.4 and 1
                        const scale = Math.min(1, Math.max(scaleW, 0.4));
                        el.style.transform = 'scale(' + scale + ')';
                        // center horizontally by translating half of leftover space
                        const left = Math.max(0, (vw - contentW * scale) / 2);
                        el.style.marginLeft = left + 'px';
                    } catch (e) {
                        // ignore
                    }
                }

                // re-fit on resize/orientation change
                $(window).on('resize orientationchange', function() { try { fitBoard(); } catch (e) {} });
                // also refit when the board has finished rendering its rows
                $(window).on('sf:boardRendered', function() { try { fitBoard(); } catch (e) {} });

                // --- Fullscreen toggle (checkbox) ---
                const fsCheckbox = $('#fullscreen-toggle-checkbox');
                function updateFsCheckbox() {
                    const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement);
                    try { fsCheckbox.prop('checked', isFs); } catch (e) {}
                }

                fsCheckbox.on('change', function() {
                    const checked = fsCheckbox.is(':checked');
                    if (checked) {
                        const el = document.documentElement;
                        if (el.requestFullscreen) el.requestFullscreen();
                        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                        else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
                    } else {
                        if (document.exitFullscreen) document.exitFullscreen();
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                    }
                });

                // Update checkbox when fullscreen state changes externally
                document.addEventListener('fullscreenchange', updateFsCheckbox);
                document.addEventListener('webkitfullscreenchange', updateFsCheckbox);
                document.addEventListener('mozfullscreenchange', updateFsCheckbox);
                updateFsCheckbox(); // initial state


            }).fail(function() {
                // fallback: try to read arrivals for title
                $.get('/api/arrivals', function(response) {
                    if (response.data && response.data.length > 0) {
                        const currentStop = response.data[0].stop;
                        $('#station-title').text(currentStop);
                    } else {
                        $('#station-title').text('No Stop Information Available');
                    }
                });
            });
        });
    </script>
</body>
</html>
